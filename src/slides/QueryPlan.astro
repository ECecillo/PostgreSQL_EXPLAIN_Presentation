---
import { Image } from 'astro:assets';
import Slide from '../components/Slide.astro';
import CodeBlock from '../components/CodeBlock.astro';

const queryPlanSchema = '/src/assets/query-plan-schema.webp';
const queryPlanSchemaText = "Query Plan de la requÃªte SQL d'exemple";

const sqlQueryExample = `		---
		CREATE INDEX index_players_on_team_id ON players(team_id);
		---
		SELECT p.name, t.name
		FROM players p
		JOIN teams t ON (t.id = p.team_id);`;

const sqlQueryPlanResultEXPLAIN = `                       QUERY PLAN
---------------------------------------------------------
 Nested Loop
   ->  Seq Scan on teams t
   ->  Materialize
     ->  Index Only Scan using index_players_on_team_id on players p
           Index Cond: (team_id = t.id)`;

const sideNotes = `
# Query Plan
- Est un arbre.
- Chaque branche est appelÃ© un "plan node".
- Chaque "plan node" commence avec \`->\`.
- Les noeuds les plus bas dans l'arbre correspondent Ã  la maniÃ¨re dont les tuples sont rÃ©cupÃ©rÃ©s dans les tables.
- Les noeuds supÃ©rieurs sont des opÃ©rations rÃ©alisÃ©s sur les enfants.

# InterprÃ©tation du plan
- La requÃªte va d'abord scanner la table "teams" (Seq Scan).
- Ensuite, elle va scanner l'index "index_players_on_team_id" de la table "players" (Index Only Scan) selon les valeurs de "team_id" rÃ©cupÃ©rÃ©es de la table "teams".
- Stocker le rÃ©sultat dans une table temporaire (Materialize).
- Enfin, elle va faire une jointure entre les deux tables (Nested Loop).
`;
---

<Slide>
	<h3>ğŸ” Un "Query Plan" c'est quoi ?</h3>
</Slide>

<Slide>
	<h3>ğŸ” Un "Query Plan" c'est quoi ?</h3>
	<CodeBlock lang="sql" lines="true">{sqlQueryExample}</CodeBlock>
</Slide>

<Slide>
	<h3>ğŸ” Un "Query Plan" c'est quoi ?</h3>
	<CodeBlock lang="sql" lines="2|4-6">{sqlQueryExample}</CodeBlock>
</Slide>

<Slide>
	<h3>ğŸ” Un "Query Plan" c'est quoi ?</h3>
	<pre><code class="language-sql" data-line-numbers="4|6,7|5|3,4,5">{sqlQueryPlanResultEXPLAIN}</code></pre>
	<aside class="notes" data-markdown>
		<textarea data-template>
			{sideNotes}
		</textarea>
	</aside>
</Slide>

<Slide>
	<Image
		src={queryPlanSchema}
		alt={queryPlanSchemaText}
		class="r-stretch"
		width={1}
		height={1}
	/>
</Slide>

<Slide>
	<h3 class="special-text">Pour rÃ©sumer,<br /> un Query plan c'est :</h3>
	<ul>
		<li>Un <b class="special-text">arbre</b>.</li>
		<li>
			<b class="special-text">Chaque branche</b> est appelÃ© un <b
				class="special-text">"plan node"</b
			>.
		</li>
		<li>
			Chaque <b class="special-text">"plan node"</b> commence avec <b
				class="special-text">-></b
			>.
		</li>
		<li>
			Les <b class="special-text">noeuds les plus bas</b> dans l'arbre correspondent
			Ã  la maniÃ¨re dont les <b class="special-text"
				>tuples sont rÃ©cupÃ©rÃ©s dans les tables</b
			>.
		</li>
		<li>
			Les <b class="special-text">noeuds supÃ©rieurs</b> sont des <b
				class="special-text">opÃ©rations</b
			> rÃ©alisÃ©s sur les <b class="special-text">enfants</b>.
		</li>
	</ul>
</Slide>
